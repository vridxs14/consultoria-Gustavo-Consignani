<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Gustavo Consignani</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">

    <!-- CSS ANTIGO + NOVO -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/dashboard-new.css">

    <!-- ÍCONES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS INLINE PARA O BOTÃO DESKTOP (SIMPLES E DIRETO) */
        .btn-logout-desktop {
            display: none;
        }

        @media (min-width: 768px) {
            .btn-logout-desktop {
                display: flex;
                align-items: center;
                gap: 5px;
                background: transparent;
                border: 1px solid #333;
                color: white;
                padding: 8px 15px;
                border-radius: 50px;
                cursor: pointer;
                transition: 0.3s;
                margin-right: 15px;
                font-size: 0.8rem;
            }

            .btn-logout-desktop:hover {
                border-color: #ff4d4d;
                color: #ff4d4d;
            }
        }
    </style>
</head>

<body>

    <div id="loading-screen"
        style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;display:flex;justify-content:center;align-items:center;">
        <i class="fas fa-circle-notch fa-spin" style="font-size:2rem;color:#CCFF00;"></i>
    </div>

    <!-- MODAL DE BOAS-VINDAS (NOVO DESIGN) -->
    <div id="welcome-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: #CCFF00; margin-bottom: 20px;"></i>
            <h2 style="color: white; margin-bottom: 10px;">Pagamento Aprovado!</h2>
            <p style="color: #ccc; margin-bottom: 25px;">Seja bem-vindo ao #TeamGustavo. O primeiro passo é falar comigo
                para eu liberar seu acesso ao app de treinos.</p>

            <a id="btn-whatsapp-start" href="#" target="_blank" class="btn btn-primary"
                style="width: 100%; border-radius: 50px; padding: 15px;">
                <i class="fab fa-whatsapp"></i> Chamar no WhatsApp
            </a>

            <button onclick="document.getElementById('welcome-modal-overlay').style.display='none'"
                style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer;">Fechar</button>
        </div>
    </div>

    <div class="dash-container">

        <!-- HEADER MOBILE/APP STYLE -->
        <header class="dash-header-mobile">
            <div class="user-greeting">
                Olá, <span id="user-name">Atleta</span>
            </div>

            <div style="display:flex; align-items:center;">
                <!-- BOTÃO SAIR (DESKTOP ONLY) -->
                <button id="logout-btn-desktop" class="btn-logout-desktop">
                    Sair <i class="fas fa-sign-out-alt"></i>
                </button>

                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </header>

        <!-- STATUS BANNER -->
        <div class="status-banner">
            <div>
                <span class="status-badge">ATIVO</span>
                <span style="color:white; font-weight:700; margin-left:10px;">Consultoria Online</span>
            </div>
            <div class="status-text"><i class="fas fa-calendar-check" style="margin-right:5px; color:#CCFF00;"></i> Dia
                1</div>
        </div>

        <!-- GRID DE CARDS -->
        <div class="glass-grid">

            <!-- CARD 1: TREINO -->
            <div class="glass-card">
                <div class="card-header">
                    <div class="card-icon-box"><i class="fas fa-dumbbell"></i></div>
                    <div>
                        <h3 class="card-title-new">Treino do Dia</h3>
                        <p style="font-size: 0.8rem; color:#666;">Foco: Hipertrofia</p>
                    </div>
                </div>
                <p class="card-desc-new">Seu treino já está disponível na plataforma MFIT. Acesse agora para registrar
                    suas cargas.</p>
                <button onclick="alert('Redirecionando para App MFIT...')" class="btn btn-primary"
                    style="width: 100%; border-radius: 50px;">
                    Acessar App <i class="fas fa-external-link-alt" style="margin-left:5px;"></i>
                </button>
            </div>

            <!-- CARD 2: ANAMNESE -->
            <div class="glass-card">
                <div class="card-header">
                    <div class="card-icon-box"><i class="fas fa-file-medical"></i></div>
                    <div>
                        <h3 class="card-title-new">Minha Anamnese</h3>
                        <p style="font-size: 0.8rem; color:#666;">Status: Pendente</p>
                    </div>
                </div>
                <p class="card-desc-new">Mantenha seus dados atualizados para eu prescrever o melhor treino possível.
                </p>
                <a href="anamnese.html" class="btn btn-secondary"
                    style="width: 100%; border-radius: 50px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">
                    Atualizar Ficha
                </a>
            </div>

            <!-- CARD 3: SUPORTE -->
            <div class="glass-card">
                <div class="card-header">
                    <div class="card-icon-box"><i class="fab fa-whatsapp"></i></div>
                    <div>
                        <h3 class="card-title-new">Falar com Coach</h3>
                        <p style="font-size: 0.8rem; color:#666;">Resposta em até 2h</p>
                    </div>
                </div>
                <p class="card-desc-new">Dúvidas na execução? Mande um vídeo ou áudio.</p>
                <a href="https://wa.me/5511999999999" target="_blank" class="btn btn-secondary"
                    style="width: 100%; border-radius: 50px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">
                    Abrir Conversa
                </a>
            </div>

        </div>
    </div>

    <!-- BOTTOM NAVIGATION (MOBILE ONLY) -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active">
            <i class="fas fa-home nav-item-icon"></i>
            <span>Início</span>
        </a>
        <a href="#" onclick="alert('Em breve: Agenda de Treinos')" class="nav-item">
            <i class="far fa-calendar-alt nav-item-icon"></i>
            <span>Agenda</span>
        </a>
        <a href="#" onclick="alert('Em breve: Histórico de Evolução')" class="nav-item">
            <i class="fas fa-chart-line nav-item-icon"></i>
            <span>Evolução</span>
        </a>
        <a href="#" id="logout-btn-mobile" class="nav-item">
            <i class="fas fa-sign-out-alt nav-item-icon"></i>
            <span>Sair</span>
        </a>
    </nav>

    <!-- SCRIPT -->
    <script type="module">
        import { auth, db } from './assets/js/firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ELEMENTOS
        const userNameSpan = document.getElementById('user-name');
        const loadingScreen = document.getElementById('loading-screen');
        const logoutMobile = document.getElementById('logout-btn-mobile');
        const logoutDesktop = document.getElementById('logout-btn-desktop');

        // PÓS-COMPRA LOGIC
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');
        const plano = urlParams.get('plano');

        if (status === 'aprovado' && plano) {
            const modal = document.getElementById('welcome-modal-overlay');
            const btnWa = document.getElementById('btn-whatsapp-start');

            modal.style.display = 'flex'; // Flex p/ centralizar

            const msg = `Olá Gustavo! Assinei o plano *${plano.toUpperCase()}* e quero começar!`;
            btnWa.href = `https://wa.me/5511999999999?text=${encodeURIComponent(msg)}`;
        }

        // AUTH CHECK
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (!user.emailVerified) {
                    alert("Verifique seu e-mail primeiro.");
                    window.location.href = 'login.html';
                    return;
                }

                // TENTATIVA 1: Usar o nome do Perfil (Mais rápido)
                if (user.displayName) {
                    userNameSpan.textContent = user.displayName.split(' ')[0];
                }

                // TENTATIVA 2: Buscar no Banco de Dados (Backup)
                try {
                    const docRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.nome) {
                            // Só sobrescreve se ainda estiver o padrão ou se quiser garantir
                            userNameSpan.textContent = data.nome.split(' ')[0];
                        }
                    } else {
                        console.log("Perfil não encontrado no banco.");
                    }
                } catch (e) {
                    console.error("Erro ao buscar perfil:", e);
                }

                loadingScreen.style.display = 'none';
            } else {
                window.location.href = 'login.html';
            }
        });

        // FUNÇÃO DE LOGOUT ÚNICA
        async function handleLogout(e) {
            e.preventDefault();
            await signOut(auth);
            window.location.href = 'login.html';
        }

        // ATRIBUIR EVENTOS
        if (logoutMobile) logoutMobile.addEventListener('click', handleLogout);
        if (logoutDesktop) logoutDesktop.addEventListener('click', handleLogout);
    </script>
</body>

</html>